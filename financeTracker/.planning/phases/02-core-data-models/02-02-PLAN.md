---
phase: 02-core-data-models
plan: 02
type: execute
---

<objective>
Create advanced schema for receipts, line items, and duplicate detection relationships.

Purpose: Enable receipt OCR capture (Phase 4), credit card bill breakdown (Phase 6), and duplicate detection linking (Phase 5) - the intelligence layer that prevents double-counting expenses.
Output: Migration additions for receipts, transaction_line_items, transaction_links, and attachments tables.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/migrations/001_core_schema.sql
@lib/db.ts

**Prior phase context:**
@.planning/phases/02-core-data-models/02-01-SUMMARY.md

**Tech stack available:**
- better-sqlite3 v12.5.0 (synchronous SQLite)
- Core schema (accounts, categories, transactions) from Plan 02-01

**Established patterns:**
- Same migration file (001_core_schema.sql) - append to it
- Integer for money (paise)
- Integer for boolean (SQLite convention)
- Foreign keys with ON DELETE CASCADE/SET NULL as appropriate

**Requirements for future phases:**
- Phase 4: Receipt OCR needs to store image, extracted text, confidence scores
- Phase 5: Duplicate detection needs to link same purchase across receipt/bank/CC statement
- Phase 6: Credit card bills have line items that reference existing transactions
- All phases: Attachments (receipt images, bill PDFs) need storage path tracking

**Key insight from PROJECT.md:**
The critical feature is knowing that "Rs. 500 grocery purchase on receipt = Rs. 500 on CC statement = part of Rs. 15,000 CC bill paid from bank." This requires transaction_links table to express relationships like "is_line_item_of", "duplicate_of", "payment_for".
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create receipts and line items tables</name>
  <files>lib/migrations/001_core_schema.sql</files>
  <action>Append two tables to migration file:

1. receipts table: id (INTEGER PRIMARY KEY AUTOINCREMENT), transaction_id (INTEGER UNIQUE REFERENCES transactions(id) ON DELETE SET NULL, nullable if receipt not yet converted to transaction), image_path (TEXT NULL for local file path), ocr_text (TEXT NULL, raw OCR output), merchant_name (TEXT NULL), total_amount (INTEGER NULL in paise), receipt_date (TEXT NULL ISO8601), confidence_score (REAL NULL 0.0-1.0 for OCR confidence), is_processed (INTEGER DEFAULT 0 to track if converted to transaction), created_at (TEXT), updated_at (TEXT). Index on is_processed for unprocessed receipt queue.

2. transaction_line_items table: id (INTEGER PRIMARY KEY AUTOINCREMENT), parent_transaction_id (INTEGER NOT NULL REFERENCES transactions(id) ON DELETE CASCADE, the CC bill or multi-item receipt), child_transaction_id (INTEGER NULL REFERENCES transactions(id) ON DELETE SET NULL, the individual purchase if already logged), description (TEXT NOT NULL), amount (INTEGER NOT NULL in paise), quantity (REAL DEFAULT 1.0), created_at (TEXT). Enables "CC bill of Rs. 15,000 contains line: Grocery Rs. 500" with optional link to the original grocery transaction. Index on parent_transaction_id for bill breakdown queries.</action>
  <verify>Both tables defined with proper foreign keys and constraints</verify>
  <done>Receipts table ready for OCR storage, line_items table supports bill breakdown</done>
</task>

<task type="auto">
  <name>Task 2: Create transaction links and attachments tables</name>
  <files>lib/migrations/001_core_schema.sql</files>
  <action>Append two final tables:

1. transaction_links table: id (INTEGER PRIMARY KEY AUTOINCREMENT), transaction_a_id (INTEGER NOT NULL REFERENCES transactions(id) ON DELETE CASCADE), transaction_b_id (INTEGER NOT NULL REFERENCES transactions(id) ON DELETE CASCADE), link_type (TEXT NOT NULL CHECK IN ('duplicate_of', 'payment_for', 'refund_of', 'split_from'), relationship_metadata (TEXT NULL for JSON with match confidence, detection method), created_at (TEXT), updated_at (TEXT). Add UNIQUE constraint on (transaction_a_id, transaction_b_id, link_type) to prevent duplicate links. Add indexes on both transaction IDs for bidirectional lookup. This is the key table for duplicate detection: "Transaction 123 duplicate_of Transaction 456 with 95% confidence".

2. attachments table: id (INTEGER PRIMARY KEY AUTOINCREMENT), entity_type (TEXT NOT NULL CHECK IN ('transaction', 'receipt'), entity_id (INTEGER NOT NULL, references transaction or receipt ID), file_path (TEXT NOT NULL, relative path in data/ directory), file_type (TEXT NOT NULL CHECK IN ('image', 'pdf', 'other'), file_size (INTEGER NULL in bytes), mime_type (TEXT NULL), created_at (TEXT). Index on (entity_type, entity_id) for fetching all attachments for a transaction/receipt. Supports multiple attachments per entity (multiple receipt photos, PDF bills).</action>
  <verify>Transaction links with relationship types defined, attachments table for file tracking</verify>
  <done>Duplicate detection and attachment storage tables complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All four tables appended to lib/migrations/001_core_schema.sql
- [ ] SQL syntax valid (test with sqlite3 if needed)
- [ ] Foreign keys properly reference existing tables
- [ ] Link types and entity types use CHECK constraints
- [ ] Indexes created for join-heavy queries
- [ ] Full migration file has 7 tables total (3 from Plan 1 + 4 from Plan 2)
</verification>

<success_criteria>

- Migration file contains all 7 tables for Phase 2
- Receipts table ready for Phase 4 OCR integration
- Line items support Phase 6 credit card bill breakdown
- Transaction links enable Phase 5 duplicate detection
- Attachments table supports multi-file storage per entity
- All constraints and indexes properly defined
  </success_criteria>

<output>
After completion, create `.planning/phases/02-core-data-models/02-02-SUMMARY.md`:

# Phase 2 Plan 2: Advanced Tracking Schema Summary

**[One-line accomplishment]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `lib/migrations/001_core_schema.sql` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 2 complete! Ready to apply migration and begin Phase 3 (Manual Entry System).
</output>
