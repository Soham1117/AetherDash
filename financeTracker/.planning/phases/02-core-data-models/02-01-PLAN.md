---
phase: 02-core-data-models
plan: 01
type: execute
---

<objective>
Create foundational database schema for accounts, categories, and transactions.

Purpose: Establish the core financial data model that all features depend on - every transaction needs an account and category, forming the backbone of expense tracking and analysis.
Output: Migration file with CREATE TABLE statements for accounts, categories, and transactions tables with proper constraints and indexes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/db.ts
@lib/db-init.ts

**Tech stack available:**
- better-sqlite3 v12.5.0 (synchronous SQLite)
- Next.js 15 with TypeScript
- Database initialization system with version tracking (_meta table)

**Established patterns:**
- Migration files in lib/migrations/ directory
- Version tracking via _meta.schema_version
- Foreign keys enabled via pragma
- Synchronous database operations

**Constraining decisions:**
- Phase 1-02: better-sqlite3 for synchronous API
- Phase 1-02: Version tracking from start for safe migrations
- Phase 1-01: TypeScript strict mode throughout

**Project requirements:**
- Track expenses across multiple accounts (bank, credit card, cash)
- Auto-categorization ready (categories with hierarchy)
- Duplicate detection foundation (transactions need matching metadata)
- Credit card bill line items link to purchases
- All data local (privacy-first)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create accounts table</name>
  <files>lib/migrations/001_core_schema.sql</files>
  <action>Create migration file with accounts table. Columns: id (INTEGER PRIMARY KEY AUTOINCREMENT), name (TEXT NOT NULL, unique), type (TEXT CHECK IN ('bank', 'credit_card', 'cash', 'other')), currency (TEXT DEFAULT 'INR'), balance (INTEGER DEFAULT 0, stored in paise/smallest unit), is_active (INTEGER DEFAULT 1), created_at (TEXT DEFAULT CURRENT_TIMESTAMP), updated_at (TEXT DEFAULT CURRENT_TIMESTAMP). Add index on type for filtering. Use INTEGER for boolean (SQLite convention). Store money as integers to avoid floating point precision issues (100.50 INR = 10050 paise).</action>
  <verify>File exists at lib/migrations/001_core_schema.sql with valid SQL syntax</verify>
  <done>Accounts table defined with all columns, constraints, and index</done>
</task>

<task type="auto">
  <name>Task 2: Create categories table with hierarchy</name>
  <files>lib/migrations/001_core_schema.sql</files>
  <action>Append categories table to migration. Columns: id (INTEGER PRIMARY KEY AUTOINCREMENT), name (TEXT NOT NULL), parent_id (INTEGER NULL REFERENCES categories(id) ON DELETE CASCADE for hierarchy), icon (TEXT NULL for emoji/icon name), color (TEXT NULL for hex color), is_system (INTEGER DEFAULT 0 to prevent deletion of auto-created categories), created_at (TEXT), updated_at (TEXT). Add UNIQUE constraint on (name, parent_id) to prevent duplicate subcategories. Add index on parent_id for hierarchy queries. Self-referencing foreign key enables unlimited nesting (Groceries > Food > Vegetables).</action>
  <verify>Categories table with self-referencing foreign key and hierarchy support</verify>
  <done>Categories table supports parent/child relationships with proper constraints</done>
</task>

<task type="auto">
  <name>Task 3: Create transactions table with source tracking</name>
  <files>lib/migrations/001_core_schema.sql</files>
  <action>Append transactions table. Columns: id (INTEGER PRIMARY KEY AUTOINCREMENT), account_id (INTEGER NOT NULL REFERENCES accounts(id)), category_id (INTEGER NULL REFERENCES categories(id), nullable for uncategorized), amount (INTEGER NOT NULL, in paise), transaction_date (TEXT NOT NULL, ISO8601 format for sorting), description (TEXT NOT NULL), notes (TEXT NULL), merchant_name (TEXT NULL for duplicate detection matching), source (TEXT CHECK IN ('manual', 'receipt_ocr', 'bank_import', 'cc_bill') to track origin), receipt_id (INTEGER NULL for Phase 4), is_expense (INTEGER NOT NULL, 1=expense/0=income for quick filtering), created_at (TEXT), updated_at (TEXT). Add indexes: (account_id, transaction_date DESC) for account history, (category_id, transaction_date DESC) for category reports, (merchant_name) for duplicate detection, (transaction_date DESC) for timeline. Amount negative for expenses follows accounting convention (already handled by is_expense flag, amount always positive).</action>
  <verify>Transactions table with all foreign keys, source tracking, and performance indexes</verify>
  <done>Transactions table connects accounts and categories with proper tracking metadata</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration file lib/migrations/001_core_schema.sql exists
- [ ] SQL syntax is valid (can test with: sqlite3 :memory: < lib/migrations/001_core_schema.sql)
- [ ] All three tables defined with proper constraints
- [ ] Foreign keys properly reference parent tables
- [ ] Indexes created for performance-critical queries
</verification>

<success_criteria>

- Migration file created with valid SQL
- Accounts table supports multiple account types
- Categories table supports unlimited hierarchy depth
- Transactions table links accounts and categories with source tracking
- All constraints (CHECK, FOREIGN KEY, UNIQUE) properly defined
- Indexes optimized for expected query patterns
  </success_criteria>

<output>
After completion, create `.planning/phases/02-core-data-models/02-01-SUMMARY.md`:

# Phase 2 Plan 1: Core Financial Schema Summary

**[One-line accomplishment]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `lib/migrations/001_core_schema.sql` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 02-02-PLAN.md (Advanced Tracking Schema)
</output>
