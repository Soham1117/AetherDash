---
phase: 01-foundation-setup
plan: 03
type: execute
---

<objective>
Add PWA manifest and basic service worker configuration for mobile installability.

Purpose: Enable the finance tracker to be installed on mobile devices as a standalone app, supporting the mobile-first receipt capture use case.
Output: PWA manifest with app metadata, basic service worker registration, and installability on mobile devices.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-setup/01-01-SUMMARY.md
@.planning/phases/01-foundation-setup/01-02-SUMMARY.md

**From Previous Plans:**
- Next.js application running with dark theme
- SQLite database integrated and working
- App structure ready for PWA features

**Requirements:**
- Mobile-responsive PWA for on-the-go receipt capture
- Installable on mobile devices
- Phase 10 will add full offline support and advanced service worker
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install next-pwa and configure for production</name>
  <files>package.json, next.config.js, public/manifest.json</files>
  <action>
    Install next-pwa for Progressive Web App support:
    - `pnpm add next-pwa`

    Update `next.config.js` to wrap config with next-pwa:
    ```javascript
    const withPWA = require('next-pwa')({
      dest: 'public',
      disable: process.env.NODE_ENV === 'development', // Disable in dev for faster refresh
      register: true,
      skipWaiting: true,
      buildExcludes: [/middleware-manifest\.json$/],
    });

    /** @type {import('next').NextConfig} */
    const nextConfig = {
      output: 'standalone',
      // Other existing config
    };

    module.exports = withPWA(nextConfig);
    ```

    Create `public/manifest.json` with app metadata:
    ```json
    {
      "name": "Finance Tracker",
      "short_name": "FinTrack",
      "description": "Track expenses with receipt OCR and smart duplicate detection",
      "start_url": "/",
      "display": "standalone",
      "background_color": "#0a0a0a",
      "theme_color": "#0a0a0a",
      "orientation": "portrait",
      "icons": [
        {
          "src": "/icon-192.png",
          "sizes": "192x192",
          "type": "image/png",
          "purpose": "any maskable"
        },
        {
          "src": "/icon-512.png",
          "sizes": "512x512",
          "type": "image/png",
          "purpose": "any maskable"
        }
      ],
      "categories": ["finance", "productivity"],
      "dir": "ltr",
      "lang": "en"
    }
    ```

    Use next-pwa (NOT @ducanh2912/next-pwa or other forks) because:
    - Most mature and stable
    - Auto-generates service worker
    - Works with Next.js 15 App Router
    - Handles cache invalidation properly

    Background/theme colors match dark theme (#0a0a0a is near-black).
  </action>
  <verify>
    - next-pwa in package.json
    - next.config.js wrapped with withPWA
    - public/manifest.json exists with correct app metadata
    - `pnpm build` succeeds and generates service worker files in public/
    - No build errors or warnings
  </verify>
  <done>
    - next-pwa installed and configured
    - PWA manifest created with dark theme colors
    - Service worker generation enabled
    - Build produces PWA files
  </done>
</task>

<task type="auto">
  <name>Task 2: Link manifest in layout and create placeholder app icons</name>
  <files>app/layout.tsx, public/icon-192.png, public/icon-512.png</files>
  <action>
    Update `app/layout.tsx` to add manifest link in metadata:
    ```typescript
    export const metadata: Metadata = {
      title: 'Finance Tracker',
      description: 'Track expenses with receipt OCR and smart duplicate detection',
      manifest: '/manifest.json',
      themeColor: '#0a0a0a',
      viewport: 'width=device-width, initial-scale=1, maximum-scale=1',
      appleWebApp: {
        capable: true,
        statusBarStyle: 'black-translucent',
        title: 'Finance Tracker',
      },
    };
    ```

    Create placeholder app icons (simple colored squares for now, Phase 9 will add proper branded icons):
    - Use ImageMagick or Node.js sharp to generate 192x192 and 512x512 PNG images
    - If ImageMagick not available, create simple canvas-based icons via Node script
    - Dark green/teal color (#10b981 or similar finance-related color)
    - Icons should be simple solid color squares with "FT" text centered

    Alternative if no image tools available: Use a simple Node script with canvas or just create minimal valid PNG files that can be replaced in Phase 9.

    For Windows without ImageMagick, use this approach:
    ```javascript
    // Simple placeholder - create 1x1 PNG and scale (basic but works)
    // Or use online tool and download, OR skip icon generation and add TODO comment
    // Phase 9 will replace with proper branded icons anyway
    ```

    Actually, simplest approach: Add TODO comments for icons and skip generation. They're not critical for Phase 1 functionality, just need manifest to be valid. Use fallback behavior.

    Update approach: Reference icons in manifest but create .gitkeep files. Document in summary that Phase 9 will add actual icons. This unblocks installability testing without spending context on icon generation.
  </action>
  <verify>
    - app/layout.tsx has manifest and PWA metadata
    - Manifest linked in HTML head
    - Icon files referenced (can be placeholders or TODO markers)
    - `pnpm build` succeeds
    - Lighthouse PWA audit shows manifest detected
  </verify>
  <done>
    - Manifest linked in app layout
    - PWA metadata added (theme color, viewport, Apple Web App)
    - Icon files referenced (placeholders, proper icons in Phase 9)
    - Build succeeds with no manifest errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    PWA configuration complete with manifest, service worker, and installability enabled.

    Built application available at: http://localhost:3000 (or production URL if deployed)
  </what-built>
  <how-to-verify>
    Desktop verification:
    1. Run: `pnpm build && pnpm start` (production mode required for PWA)
    2. Visit: http://localhost:3000
    3. Open Chrome DevTools → Application tab → Manifest
    4. Verify: Manifest loads with "Finance Tracker" name, dark theme colors
    5. Check: Service Worker registered (Application → Service Workers)
    6. Lighthouse: Run PWA audit, should pass manifest and service worker checks

    Mobile verification (recommended):
    1. Deploy to Vercel or use ngrok to expose localhost
    2. Visit URL on mobile device (iOS Safari or Android Chrome)
    3. iOS: Tap Share → Add to Home Screen (should show app name and icon)
    4. Android: Tap menu → Install app (should show install prompt)
    5. Launch: App opens in standalone mode (no browser UI)

    Expected results:
    - Manifest detected and valid
    - Service worker registered (in production build)
    - Installable on mobile devices
    - App launches in standalone mode when installed
  </how-to-verify>
  <resume-signal>Type "approved" if PWA functionality verified, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm build` succeeds with service worker generation
- [ ] `pnpm start` runs production build
- [ ] Manifest accessible at /manifest.json
- [ ] Chrome DevTools shows manifest and service worker
- [ ] Lighthouse PWA audit passes core checks
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- PWA manifest valid and linked
- Service worker registered in production
- App installable on mobile devices
- Phase 1 complete: Next.js + SQLite + PWA foundation ready
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-setup/01-03-SUMMARY.md`:

# Phase 1 Plan 3: PWA Configuration Summary

**Progressive Web App manifest and service worker configured for mobile installability.**

## Accomplishments

- next-pwa integrated with Next.js application
- PWA manifest created with dark theme metadata
- Service worker auto-generated for production builds
- App metadata configured for mobile installation
- Installability verified on mobile devices

## Files Created/Modified

- `package.json` - Added next-pwa
- `next.config.js` - Wrapped with PWA configuration
- `public/manifest.json` - App manifest with metadata
- `app/layout.tsx` - Added manifest link and PWA metadata
- `public/` - Service worker files generated on build

## Tech Stack Added

- next-pwa (Progressive Web App support)
- Service worker (auto-generated)
- PWA manifest

## Decisions Made

- **next-pwa over manual SW**: Auto-generates optimal service worker, handles cache invalidation
- **Disabled in development**: Faster hot reload during development, enabled in production
- **Standalone display mode**: Full-screen app experience when installed
- **Dark theme colors**: Background/theme colors match app's dark mode (#0a0a0a)

## Issues Encountered

(Document any icon generation issues or installation testing results)

## Next Phase Readiness

**Phase 1 Complete!** Foundation fully established:
- ✅ Next.js application with TypeScript and Tailwind
- ✅ SQLite database integrated and working
- ✅ PWA manifest for mobile installation
- ✅ Dark theme configured throughout
- ✅ Project structure ready for features

Ready for **Phase 2: Core Data Models** - database schema design and implementation.

## Phase Completion

Phase 1 delivers on all roadmap goals:
- Working Next.js application ✅
- SQLite database integration ✅
- Basic PWA manifest ✅
- Foundation for all future phases ✅
</output>
