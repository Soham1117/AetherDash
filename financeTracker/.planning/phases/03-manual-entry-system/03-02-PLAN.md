---
phase: 03-manual-entry-system
plan: 02
type: execute
---

<objective>
Create category management system with hierarchical support for organizing expenses and income.

Purpose: Categories enable expense classification and future analytics. Hierarchy allows detailed tracking (e.g., Food > Groceries > Vegetables).
Output: Working categories CRUD with nested display and parent-child relationship management.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-data-models/02-01-SUMMARY.md
@.planning/phases/03-manual-entry-system/03-01-SUMMARY.md

@lib/db.ts
@lib/migrations/001_core_schema.sql
@components/ui/button.tsx
@components/ui/input.tsx
@components/ui/card.tsx

**Tech stack available:**
- Next.js 16 with App Router
- better-sqlite3 (synchronous API)
- Shadcn UI components
- Tailwind CSS v4

**Established patterns:**
- Hierarchical categories via self-referencing parent_id
- UNIQUE(name, parent_id) prevents duplicate subcategories
- is_system flag for protected categories

**Constraining decisions:**
- Phase 2-01: Categories support unlimited nesting via parent_id
- Phase 2-01: ON DELETE CASCADE removes children when parent deleted
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create categories API endpoints</name>
  <files>app/api/categories/route.ts, app/api/categories/[id]/route.ts</files>
  <action>
Create REST API for categories:

**GET /api/categories** - List all categories
- Return flat array with parent_id relationships
- Client will build tree structure
- Order by name for consistent display

**POST /api/categories** - Create category
- Accept: { name, parent_id?, icon?, color? }
- Validate: name required
- parent_id must reference existing category if provided
- Return created category with 201

**GET /api/categories/[id]** - Get single category
- Return 404 if not found

**PUT /api/categories/[id]** - Update category
- Accept partial updates
- Prevent setting parent_id to self or descendant (circular reference)
- Return updated category

**DELETE /api/categories/[id]** - Delete category
- Return 204 on success
- CASCADE will delete children (warn user in UI)
- Prevent deletion of is_system=1 categories

For circular reference check: Query all descendants recursively before allowing parent_id update. Simple approach: reject if new parent_id equals id or if new parent's ancestors include this category.
  </action>
  <verify>
curl http://localhost:3000/api/categories returns 200 with empty array
curl -X POST http://localhost:3000/api/categories -H "Content-Type: application/json" -d '{"name":"Food"}' returns 201
  </verify>
  <done>All 5 endpoints work with proper hierarchy validation. Circular reference prevention works.</done>
</task>

<task type="auto">
  <name>Task 2: Create categories management UI with tree display</name>
  <files>app/categories/page.tsx, components/categories/category-form.tsx, components/categories/category-tree.tsx</files>
  <action>
Create categories management page at /categories:

**Category Tree Component (category-tree.tsx):**
- Build tree structure from flat API response
- Render nested list with indentation (padding-left per level)
- Show icon (emoji) and name for each category
- Expand/collapse for categories with children
- Edit and Delete buttons (inline or on hover)
- "Add Subcategory" button for each category

**Category Form Component (category-form.tsx):**
- Fields: name (text), parent (select from existing categories), icon (emoji picker or text input), color (optional)
- Parent dropdown shows hierarchy with indentation
- Edit mode pre-fills values
- Validation: name required

**Categories Page (page.tsx):**
- "Add Category" button for root-level categories
- Category tree below
- Delete confirmation warns about child deletion

Display as indented tree. Use simple visual hierarchy (borders, background shading). Keep icons as emoji for simplicity (user types emoji in text field).

Dark theme styling consistent with accounts page.
  </action>
  <verify>npm run build succeeds without TypeScript errors</verify>
  <done>Categories page renders at /categories with tree view, add/edit/delete functional, subcategory creation works.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Category management system with hierarchical tree display</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000/categories
    3. Test: Add root category "Food"
    4. Test: Add subcategory "Groceries" under Food
    5. Test: Add subcategory "Vegetables" under Groceries
    6. Verify: Tree displays Food > Groceries > Vegetables with proper nesting
    7. Test: Edit "Groceries" to rename it
    8. Verify: Name updates, hierarchy preserved
    9. Test: Delete "Food"
    10. Verify: All children deleted (Groceries, Vegetables gone)
    11. Check: Mobile responsive
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All API endpoints return correct status codes
- [ ] TypeScript compilation passes
- [ ] Categories page accessible at /categories
- [ ] Hierarchy creation and display works
- [ ] Cascade delete works correctly
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Category hierarchy fully functional
</success_criteria>

<output>
After completion, create `.planning/phases/03-manual-entry-system/03-02-SUMMARY.md` following summary template.
</output>
