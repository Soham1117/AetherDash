---
phase: 03-manual-entry-system
plan: 03
type: execute
---

<objective>
Create transaction entry system - the core feature for logging expenses and income.

Purpose: This is the primary user interaction point. Users log purchases, bills, and income here.
Output: Transaction entry form with account/category selection, and transaction list with basic filtering.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-data-models/02-01-SUMMARY.md
@.planning/phases/03-manual-entry-system/03-01-SUMMARY.md
@.planning/phases/03-manual-entry-system/03-02-SUMMARY.md

@lib/db.ts
@lib/migrations/001_core_schema.sql
@app/api/accounts/route.ts
@app/api/categories/route.ts
@components/ui/button.tsx
@components/ui/input.tsx
@components/ui/card.tsx

**Tech stack available:**
- Next.js 16 with App Router
- better-sqlite3 (synchronous API)
- Shadcn UI components
- Tailwind CSS v4

**Established patterns:**
- Money as INTEGER in paise
- Transaction source: 'manual' for user-entered
- merchant_name for future duplicate detection

**Constraining decisions:**
- Phase 2-01: Transactions require account_id, source tracking enables Phase 5
- Phase 2-01: Four performance indexes on transactions table
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create transactions API endpoints</name>
  <files>app/api/transactions/route.ts, app/api/transactions/[id]/route.ts</files>
  <action>
Create REST API for transactions:

**GET /api/transactions** - List transactions with filtering
- Query params: account_id, category_id, start_date, end_date, limit (default 50), offset
- Order by transaction_date DESC (most recent first)
- Return array with account and category names joined

**POST /api/transactions** - Create transaction
- Accept: { account_id, category_id?, amount, transaction_date, description, merchant_name?, notes?, is_expense }
- Validate: account_id required and must exist, amount > 0, transaction_date required, description required
- Set source = 'manual' automatically
- Convert amount from rupees to paise before storing
- Update account balance: subtract for expense, add for income
- Return created transaction with 201

**GET /api/transactions/[id]** - Get single transaction
- Include account and category details
- Return 404 if not found

**PUT /api/transactions/[id]** - Update transaction
- Recalculate account balance if amount or is_expense changed
- Handle account change (adjust both old and new account balances)
- Return updated transaction

**DELETE /api/transactions/[id]** - Delete transaction
- Reverse the balance change on the account
- Return 204 on success

Important: Balance updates must be atomic. Use db.transaction() wrapper to ensure account balance and transaction are updated together.
  </action>
  <verify>
curl http://localhost:3000/api/transactions returns 200 with empty array
curl -X POST http://localhost:3000/api/transactions -H "Content-Type: application/json" -d '{"account_id":1,"amount":100,"transaction_date":"2026-01-09","description":"Test","is_expense":true}' returns 201
  </verify>
  <done>All 5 endpoints work. Account balance updates correctly on create/update/delete. Filtering by date and account works.</done>
</task>

<task type="auto">
  <name>Task 2: Create transaction entry form</name>
  <files>app/transactions/page.tsx, components/transactions/transaction-form.tsx</files>
  <action>
Create transaction entry form:

**Transaction Form Component (transaction-form.tsx):**
- Type toggle: Expense (default) / Income
- Amount input (in rupees, shows Rs. prefix)
- Date picker (HTML date input, defaults to today)
- Account selector (dropdown from accounts API)
- Category selector (dropdown showing hierarchy with indentation)
- Description (required text)
- Merchant name (optional, for future duplicate detection)
- Notes (optional textarea)
- Submit button

Form behavior:
- Fetch accounts and categories on mount
- Disable submit until required fields filled
- Show loading state during submission
- Clear form after successful submit (or close modal)
- Edit mode pre-fills all values

**Transactions Page (page.tsx):**
- "Add Transaction" button (prominent, maybe floating on mobile)
- Transaction list below (use existing pattern from accounts)
- Quick filters: This month, Last month, All time
- Account filter dropdown
  </action>
  <verify>npm run build succeeds without TypeScript errors</verify>
  <done>Transaction form renders with all fields, account/category dropdowns populated, form submission creates transaction.</done>
</task>

<task type="auto">
  <name>Task 3: Create transaction list with display formatting</name>
  <files>components/transactions/transaction-list.tsx, components/transactions/transaction-item.tsx</files>
  <action>
Create transaction list display:

**Transaction Item Component (transaction-item.tsx):**
- Display: date, description, amount (red for expense, green for income)
- Show account name and category with icon
- Merchant name if present (smaller text)
- Edit and Delete buttons
- Swipe-to-delete on mobile (stretch goal - skip if complex)

**Transaction List Component (transaction-list.tsx):**
- Fetch transactions with current filters
- Group by date (Today, Yesterday, This Week, Earlier) - or simple chronological list
- Infinite scroll or "Load more" button
- Empty state: "No transactions yet. Add your first expense!"
- Loading skeleton while fetching

Display formatting:
- Amount: Rs. X,XXX.XX (Indian number formatting with commas)
- Date: "Jan 9, 2026" or relative ("Today", "Yesterday")
- Color: expense amounts in red/orange, income in green

Update transactions page to use these components with the filter state.
  </action>
  <verify>npm run build succeeds without TypeScript errors</verify>
  <done>Transaction list displays properly formatted transactions with account/category info, edit/delete work, filtering applies correctly.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] Transaction CRUD works end-to-end
- [ ] Account balance updates correctly when transactions added/edited/deleted
- [ ] Filtering by account and date works
- [ ] Amount displays in rupees with proper formatting
- [ ] Expense/income distinguished visually
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Transaction entry is the primary workflow users can complete
- Phase 3 complete: Manual entry system fully functional
</success_criteria>

<output>
After completion, create `.planning/phases/03-manual-entry-system/03-03-SUMMARY.md` following summary template.

This completes Phase 3. Update STATE.md and ROADMAP.md to reflect phase completion.
</output>
